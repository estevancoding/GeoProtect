<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Painel de Controle - GeoProtect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 80vh; width: 100%; }
    </style>
</head>
<body>
<h1>Painel de Controle da Demonstração</h1>
<p>Clique no mapa para definir uma localização e verificar se está em uma zona de risco.</p>

<div id="map"></div>

<script>
    // =================================================================
    // 1. INICIALIZAÇÃO E VARIÁVEIS
    // =================================================================
    var map = L.map('map').setView([-23.550520, -46.633308], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    var staticLocationMarker = null;

    // =================================================================
    // 2. FUNÇÃO PARA CLIQUE ESTÁTICO
    // =================================================================
    function handleStaticMapClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        const locationData = { lat: lat, lng: lng };

        fetch('/api/demo/check-location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(status => {
            if (staticLocationMarker) map.removeLayer(staticLocationMarker);
            staticLocationMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`<b>Status:</b> ${status.message}`)
                .openPopup();
        });
    }

    // =================================================================
    // 3. LÓGICA DE CARREGAMENTO INICIAL
    // =================================================================

    // Desenhar Zonas de Risco no mapa
    fetch('/api/v1/zonas-de-risco')
        .then(response => response.json())
        .then(zonas => {
            zonas.forEach(zona => {
                const latLngs = zona.area.coordinates[0].map(coord => [coord[1], coord[0]]);
                const polygon = L.polygon(latLngs, { color: 'red', fillColor: '#f03', fillOpacity: 0.5 });
                polygon.addTo(map);
            });
        });

    // =================================================================
    // 4. EVENTOS DO MAPA
    // =================================================================
    map.on('click', handleStaticMapClick);
</script>
</body>
</html>
