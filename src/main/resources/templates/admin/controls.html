<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Painel de Controle - GeoProtect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.animatedmarker@1.0.0/src/AnimatedMarker.js"></script>
    <style>
        #map { height: 80vh; width: 100%; }
    </style>
</head>
<body>
<h1>Painel de Controle da Demonstração</h1>
<p>A simulação começará automaticamente. Clique no mapa para definir uma localização estática.</p>
<div id="map"></div>

<script>
    // =================================================================
    // 1. INICIALIZAÇÃO DO MAPA E VARIÁVEIS GLOBAIS
    // =================================================================
    var map = L.map('map').setView([-23.550520, -46.633308], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    var staticLocationMarker = null;

    // =================================================================
    // 2. FUNÇÃO REUTILIZÁVEL PARA O CLIQUE NO MAPA (ESTÁTICO)
    // =================================================================
    function handleStaticMapClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        const locationData = { lat: lat, lng: lng };

        fetch('/api/demo/update-location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(locationData)
        }).then(response => {
            if (response.ok) {
                if (staticLocationMarker) map.removeLayer(staticLocationMarker);
                staticLocationMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup('Localização estática definida aqui!')
                    .openPopup();
            }
        });
    }

    // =================================================================
    // 3. LÓGICA DE CARREGAMENTO INICIAL DA PÁGINA
    // =================================================================

    // 3.1 - Buscar e desenhar as Zonas de Risco
    fetch('/api/v1/zonas-de-risco')
        .then(response => response.json())
        .then(zonas => {
            zonas.forEach(zona => {
                const latLngs = zona.area.coordinates[0].map(coord => [coord[1], coord[0]]);
                const polygon = L.polygon(latLngs, { color: 'red', fillColor: '#f03', fillOpacity: 0.5 });
                polygon.on('click', (e) => {
                    L.popup().setLatLng(e.latlng).setContent('<b>Zona: </b>' + zona.nome).openOn(map);
                    handleStaticMapClick(e);
                });
                polygon.addTo(map);
            });
        });

    // 3.2 - Buscar o caminho e iniciar a animação do pino
    fetch('/api/v1/caminho')
        .then(response => response.json())
        .then(caminho => {
            const latLngs = caminho.trajeto.coordinates.map(coord => [coord[1], coord[0]]);

            let totalDistance = 0;
            for (let i = 0; i < latLngs.length - 1; i++) {
                totalDistance += map.distance(latLngs[i], latLngs[i + 1]);
            }

            const desiredDurationSeconds = 90;
            const speedMetersPerSecond = totalDistance / desiredDurationSeconds;
            const intervalMilliseconds = 10000; // Agora atualiza a cada 1 segundo
            const distancePerStep = speedMetersPerSecond * (intervalMilliseconds / 1000);

            const animatedMarker = L.animatedMarker(latLngs, {
                distance: distancePerStep,
                interval: intervalMilliseconds,
                autoStart: true,
                onEnd: function() { this.remove(); }
            });

            map.addLayer(animatedMarker);

            animatedMarker.on('move', function(e) {
                const locationData = { lat: e.latlng.lat, lng: e.latlng.lng };
                fetch('/api/demo/update-location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData)
                });
            });
        });

    // =================================================================
    // 4. EVENTOS DO MAPA
    // =================================================================
    map.on('click', handleStaticMapClick);
</script>
</body>
</html>